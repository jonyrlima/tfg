[DEFNAME ADV_ALCH_DEFS]
ADVALCHMAXITEMS 11
def_0	3620
def_i_reag_black_pearl	3962
def_i_reag_nightshade	3976
def_i_reag_spider_silk	3981
def_i_reag_sulfur_ash	3980
def_i_reag_mandrake_root	3974
def_i_reag_garlic	3972
def_i_reag_ginseng	3973
def_i_reag_blood_moss	3963
def_i_reag_batwing	3960
def_i_reag_blackmoor	3961
def_i_reag_blood_spawn	3964
def_i_reag_bone	3966
def_i_reag_brimstone	3967
def_i_reag_daemon_bone	3968
def_i_reag_dead_wood	3984
def_i_reag_dragon_blood	3970
def_i_reag_eye_of_newt	3975
def_i_reag_obsidian	3977
def_i_reag_fertile_dirt	3969
def_i_reag_executioners_cap	3971
def_i_reag_pig_iron	3978
def_i_reag_pumice	3979
def_i_reag_serpent_scale	3982
def_i_reag_blood_vial	3965
def_i_reag_volcanic_ash	3983
def_i_reag_worm_heart	3985
def_i_reag_black_pearl_name	Bp
def_i_reag_nightshade_name	NS
def_i_reag_spider_silk_name	SS
def_i_reag_sulfur_ash_name	SA
def_i_reag_mandrake_root_name	MR
def_i_reag_garlic_name	Ga
def_i_reag_ginseng_name	Gi
def_i_reag_blood_moss_name	BM
def_i_reag_batwing_name	Bw
def_i_reag_blackmoor_name	Bm
def_i_reag_blood_spawn_name	Bs
def_i_reag_bone_name	Bn
def_i_reag_brimstone_name	Bt
def_i_reag_daemon_bone_name	DB
def_i_reag_dead_wood_name	DW
def_i_reag_dragon_blood_name	Dl
def_i_reag_eye_of_newt_name	EN
def_i_reag_obsidian_name	Ob
def_i_reag_fertile_dirt_name	FD
def_i_reag_worm_heart_name	WH


[ITEMDEF I_ADV_ALCHEMY]
NAME=Advanced Alchemy Kit
ID=i_dishing_stump
WEIGHT=30
TYPE=T_NORMAL
RESOURCES=50 I_DARK_LOG, 10 I_INGOT_RUSTY
SKILLMAKE= Carpentry 70.0, Alchemy 50.0, Tinkering 60.0, T_CARPENTRY

ON=@CREATE
	COLOR 0455
	FOR 1 <DEF.ADVALCHMAXITEMS>
		TAG.REG<DLOCAL._FOR>_NAME Vazio
	ENDFOR

ON=@CLICK
	Message <EVAL 40-<DTAG0.USAGE>> charges
	IF (<CONT.TOPOBJ> != <SRC>)
		SRC.SYSMESSAGE @,,1 Este item nao pode ser usado fora de sua bag/bank.
		MESSAGE <NAME>
		RETURN 1
	ENDIF

	IF (<SRC.CTAG0.KEGTOBEDONE> != 0)
		SRC.SYSMESSAGE You are too busy to do this
		RETURN 1
	ENDIF

	FOR 0 3
		SRC.DIALOGCLOSE D_ADVA_<dlocal._for>
	ENDFOR
		src.dialogclose D_ADVA_LEG
		SRC.DIALOGCLOSE D_ADV_ALCH_KIT
		SRC.DIALOGCLOSE D_ADVA_RMV
		SRC.DIALOGCLOSE d_adva_rmv_conf

	SRC.CTAG0.ALCHKITCLICKED <UID>
	SRC.DIALOG D_ADV_ALCH_KIT


ON=@DCLICK
	IF (<CONT.TOPOBJ> != <SRC>)
		SRC.SYSMESSAGE @,,1 Este item nao pode ser usado fora de sua bag.
		RETURN 1
	ENDIF
	IF (<SRC.CTAG0.KEGTOBEDONE> != 0)
		SRC.SYSMESSAGE You are too busy to do this
		RETURN 1
	ENDIF

	IF <SRC.ALCHEMY> < 700
		SRC.SYSMESSAGE You lack skill to use that.
		RETURN 1
	ENDIF
	IF <DTAG0.USAGE> >= 40
		SRC.SYSMESSAGE Your advanced kit lost its power. Add 40 Dark logs to it.
		RETURN 1
	ENDIF

	FOR 0 3
		SRC.DIALOGCLOSE D_ADVA_<dlocal._for>
	ENDFOR
	src.dialogclose D_ADVA_LEG
	SRC.DIALOGCLOSE D_ADV_ALCH_KIT
	SRC.DIALOGCLOSE D_ADVA_RMV
	SRC.DIALOGCLOSE d_adva_rmv_conf
	SRC.CTAG0.ALCHKITDCLICKED <UID>
	src.dialog d_adva_0
	RETURN 1
ENDIF

[FUNCTION F_ADDREG]
REF1 = <UID.<ARGS>>

IF (<ARGO.TOPOBJ> != <SRC>)
	SRC.SYSMESSAGE @,,1 O item deve estar no seu bank ou na sua bag.
	RETURN 1
ENDIF

IF (<ARGO.TYPE> == T_REAGENT)
	LOCAL.SLOTTOADD 0
	LOCAL.SLOTTOCREATE 0

	FOR 1 <DEF.ADVALCHMAXITEMS> //VERIFICAR SE JA EXISTE ESSE REG NO Kit
		IF   (<ARGO.BASEID> == <REF1.TAG0.REG<DLOCAL._FOR>>)
			LOCAL.SLOTTOADD <DLOCAL._FOR>
		ENDIF
	ENDFOR

	IF (<DLOCAL.SLOTTOADD> == 0) //SE NAO TIVER O REG NO Kit, VERIFICAR SE EXISTE SLOT VAZIO PARA ADICIONAR
		FOR 1 <DEF.ADVALCHMAXITEMS>
			IF !(<REF1.TAG0.REG<DLOCAL._FOR>>) && (<DLOCAL.SLOTTOCREATE> == 0)
				LOCAL.SLOTTOCREATE <DLOCAL._FOR>
			ENDIF
		ENDFOR
			a
		IF (<DLOCAL.SLOTTOCREATE> == 0) //NAO EXISTE SLOT VAZIO, FIM.
			SRC.SYSMESSAGE @,,1 Todos slots estao preenchidos.
			RETURN 1
		ELIF (<DLOCAL.SLOTTOCREATE> > 0) //EXISTE SLOT VAZIO, CRIAR E PREENCHER ELE E REMOVER REGS
			REF1.TAG0.REG<DLOCAL.SLOTTOCREATE> <ARGO.BASEID>
			REF1.TAG0.REG<DLOCAL.SLOTTOCREATE>_NAME <ARGO.NAME>
			REF1.TAG0.REG<DLOCAL.SLOTTOCREATE>_AMT += <ARGO.AMOUNT>
			SRC.SYSMESSAGE @,,1 <ARGO.AMOUNT> <ARGO.NAME> Adicionado ao Kit. Agora voce tem <REF1.dTAG0.REG<DLOCAL.SLOTTOCREATE>_AMT> no Slot <dLOCAL.SLOTTOCREATE>.
			ARGO.REMOVE
			SRC.DIALOG D_ADV_ALCH_KIT
			RETURN 1
		ELSE //ERRO
			SRC.SYSMESSAGE Ocorreu um erro. Envie uma page para staff. Erro [1]
			RETURN 1
		ENDIF
	ELIF (<DLOCAL.SLOTTOADD> > 0) //JA EXISTE O REG NO Kit, ADICIONAR AMT
		REF1.TAG0.REG<DLOCAL.SLOTTOADD>_AMT += <ARGO.AMOUNT>
		SRC.SYSMESSAGE @,,1 <ARGO.AMOUNT> <ARGO.NAME> Adicionado ao Kit. Agora voce tem <REF1.dTAG0.REG<DLOCAL.SLOTTOADD>_AMT> no Slot <dLOCAL.SLOTTOADD>.
		ARGO.REMOVE
		RETURN 1
	ELSE //ERRO
		SRC.SYSMESSAGE Ocorreu um erro. Envie uma page para staff. Erro [2]
		RETURN 1
	ENDIF
ELSE
	SRC.SYSMESSAGE @,,1 Isso nao ï¿½ um reagente.
	RETURN 1
ENDIF


[FUNCTION F_CRAFTKEG]

REF2 <UID.<ARGV[0]>> //ITEM ONDE ESTAO OS REGS
LOCAL.SLOT_0 <ARGV[1]> //SLOT A SER DEBITADO REGS
LOCAL.SLOT_1 <ARGV[6]>
LOCAL.SLOT_2 <ARGV[7]>
LOCAL.SLOT_3 <ARGV[8]>
LOCAL.MULT <ARGV[2]> //MULTIPLICADOR
REF3 <UID.<ARGV[3]>> //SRC PLAYER Backpack
LOCAL.REGNDD <ARGV[4]>
LOCAL.REGSTOTAL <EVAL <DLOCAL.REGNDD>*<LOCAL.MULT>>
LOCAL.REGN <ARGV[5]>

IF ((<SRC.FOOD> >= <SRC.MAXFOOD>) && (<SRC.ALCHEMY> >= 1000)) || (<R10> != 1)
//ACERTAR A KEG
	IF (<DLOCAL.MULT> == 100)
		SRC.CTAG0.KEGTOBEDONE = <SRC.CTAG.KEGTOBEDONE>1
	ENDIF

	IF (<REF2.TAG0.REG<DLOCAL.SLOT_0>_AMT> >= <DLOCAL.REGSTOTAL>) && (<SRC.RESTEST 1 I_KEG_SMALL>)

		IF <DLOCAL.REGN> == 1
			//CONSUMIR RESOURCES
			REF2.TAG0.REG<DLOCAL.SLOT_0>_AMT -= <DLOCAL.REGSTOTAL>
			SRC.CONSUME 1 I_KEG_SMALL
			//src.S TEST
			IF (0 >= <REF2.TAG0.REG<DLOCAL.SLOT_0>_AMT>)
				REF2.TAG0.REG<DLOCAL.SLOT_0>
				REF2.TAG0.REG<DLOCAL.SLOT_0>_AMT
				REF2.TAG0.REG<DLOCAL.SLOT_0>_NAME Vazio
			ENDIF

			SERV.NEWITEM <SRC.CTAG0.KEGTOBEDONE>
			SRC.F_GM_QUEST_SKILL_INCREASE 0,<SRC.CTAG0.KEGTOBEDONE>
			NEW.CONT <REF3>
			SRC.SYSMESSAGE You have crafted your keg successfully and put it in your bag.
			REF2.TAG0.USAGE ++
			IF <REF2.TAG0.USAGE> >= 40
				REF2.COLOR 0457
				SRC.SYSMESSAGE @,,1 Your kit has run out of charges..
			ENDIF
			SRC.F_KEG_RESETCTAGS
		ELSE
			SRC.CONSUME 1 I_KEG_SMALL
			FOR 0 <DLOCAL.REGN>
				//CONSUMIR RESOURCES
				REF2.TAG0.REG<DLOCAL.SLOT_<DLOCAL._FOR>>_AMT -= <DLOCAL.REGSTOTAL>

				IF (0 >= <REF2.TAG0.REG<DLOCAL.SLOT_<DLOCAL._FOR>>_AMT>)
					REF2.TAG0.REG<DLOCAL.SLOT_<DLOCAL._FOR>>
					REF2.TAG0.REG<DLOCAL.SLOT_<DLOCAL._FOR>>_AMT
					REF2.TAG0.REG<DLOCAL.SLOT_<DLOCAL._FOR>>_NAME Vazio
				ENDIF
			ENDFOR
			SERV.NEWITEM <SRC.CTAG0.KEGTOBEDONE>
			SRC.F_GM_QUEST_SKILL_INCREASE 0,<SRC.CTAG0.KEGTOBEDONE>
			NEW.CONT <REF3>
			SRC.F_KEG_RESETCTAGS
			REF2.TAG0.USAGE ++
			IF <REF2.TAG0.USAGE> >= 40
				SRC.SYSMESSAGE @,,1 Your kit has run out of charges..
				REF2.COLOR 0457
			ENDIF
			SRC.SYSMESSAGE You have crafted your keg successfully and put it in your bag.
		ENDIF

	ELSE
		SRC.SYSMESSAGE Voce nao possui todos os itens necessarios para craftar a keg. (Reagents + Empty Keg)
		SRC.F_KEG_RESETCTAGS
		RETURN 1
	ENDIF

ELSE
//ERRAR A KEG

	SRC.SYSMESSAGE You have failed to craft the item.
	SRC.F_KEG_RESETCTAGS

ENDIF

[FUNCTION F_ADVA_BEGIN]
REF1 <UID.<SRC.CTAG0.ALCHKITDCLICKED>>
LOCAL.REGN 1
FOR 1 3
	IF (<SRC.CTAG0.ADVAREG_<DLOCAL._FOR>> != 0)
		LOCAL.REGN <DLOCAL._FOR>+1
	ENDIF
ENDFOR
LOCAL.SLOTTOCONSUME_0 0
LOCAL.SLOTTOCONSUME_1 0
LOCAL.SLOTTOCONSUME_2 0
LOCAL.SLOTTOCONSUME_3 0
LOCAL.REGNEEDED <ARGS>
LOCAL.AMTPRECISA <EVAL <SRC.DCTAG0.ADVA>*<DLOCAL.REGNEEDED>>

IF (<SRC.RESTEST 1 I_KEG_SMALL>)

	FOR 1 <DEF.ADVALCHMAXITEMS> //VERIFICAR SE EXISTE ESSE REG NO Kit
		IF (<SRC.CTAG0.ADVAREG_0> == <REF1.TAG0.REG<DLOCAL._FOR>>)
			LOCAL.SLOTTOCONSUME_0 <DLOCAL._FOR>
		ENDIF
		IF (<DLOCAL.REGN> > 1)
			IF (<SRC.CTAG0.ADVAREG_1> == <REF1.TAG0.REG<DLOCAL._FOR>>)
				LOCAL.SLOTTOCONSUME_1 <DLOCAL._FOR>
			ENDIF
			IF (<DLOCAL.REGN> > 2)
				IF   (<SRC.CTAG0.ADVAREG_2> == <REF1.TAG0.REG<DLOCAL._FOR>>)
					LOCAL.SLOTTOCONSUME_2 <DLOCAL._FOR>
				ENDIF
				IF (<DLOCAL.REGN> > 3)
					IF   (<SRC.CTAG0.ADVAREG_3> == <REF1.TAG0.REG<DLOCAL._FOR>>)
						LOCAL.SLOTTOCONSUME_3 <DLOCAL._FOR>
					ENDIF
				ENDIF
			ENDIF
		ENDIF
	ENDFOR

	//VERIFICAR SE ENCONTROU OS REGS
	IF <LOCAL.SLOTTOCONSUME_0> == 0
		SRC.SYSMESSAGE @,,1 Voce nao possui o reagente necessario para craftar essa keg. [REG: <DEF.DEF_<SRC.CTAG0.ADVAREG_0>_NAME>]
		SRC.F_KEG_RESETCTAGS
		RETURN 1
	ELIF (<DLOCAL.REGN> > 1)
		FOR 1 <EVAL <DLOCAL.REGN>-1>
			IF (<DLOCAL.SLOTTOCONSUME_<DLOCAL._FOR>> == 0)
				SRC.SYSMESSAGE @,,1 Voce nao possui os reagentes necessario para craftar essa keg. [REG: <DEF.DEF_<SRC.CTAG0.ADVAREG_<DLOCAL._FOR>>_NAME>]
				SRC.F_KEG_RESETCTAGS
				RETURN 1
			ENDIF
		ENDFOR
	ENDIF

	//VERIFICAR SE TEM O AMOUNT CORRETO DE REG
	LOCAL.AMTTEM_0 <REF1.DTAG0.REG<DLOCAL.SLOTTOCONSUME_0>_AMT>
	LOCAL.AMTTEM_1 <REF1.DTAG0.REG<DLOCAL.SLOTTOCONSUME_1>_AMT>
	LOCAL.AMTTEM_2 <REF1.DTAG0.REG<DLOCAL.SLOTTOCONSUME_2>_AMT>
	LOCAL.AMTTEM_3 <REF1.DTAG0.REG<DLOCAL.SLOTTOCONSUME_3>_AMT>


	IF !( <DLOCAL.AMTTEM_0> >= <DLOCAL.AMTPRECISA>)
		SRC.SYSMESSAGE @,,1 Voce nao possui amount de reagentes suficientes no kit. [REG: <DEF.DEF_<SRC.CTAG0.ADVAREG_0>_NAME>]
		SRC.F_KEG_RESETCTAGS
		RETURN 1
	ENDIF
	IF (<DLOCAL.REGN> > 1)
		FOR 1 <EVAL <DLOCAL.REGN>-1>
			IF !( <DLOCAL.AMTTEM_<DLOCAL._FOR>> >= <DLOCAL.AMTPRECISA>)
				SRC.SYSMESSAGE @,,1 Voce nao possui amount de reagentes suficientes no kit. [REG: <DEF.DEF_<SRC.CTAG0.ADVAREG_<DLOCAL._FOR>>_NAME>]
				SRC.F_KEG_RESETCTAGS
				RETURN 1
			ENDIF
		ENDFOR
	ENDIF
ELSE
	SRC.SYSMESSAGE @,,1 Voce nao possui uma empty keg em sua bag.
	SRC.F_KEG_RESETCTAGS
	RETURN 1
ENDIF

IF (<DLOCAL.SLOTTOCONSUME_0> != 0) && (<DLOCAL.REGN> == 1)
	SRC.ANIM 9
	SRC.EMOTE start dancing the tchaka and mix stuff
	TIMERF 2, SRC.ANIM 9
	TIMERF 3, F_CRAFTKEG <REF1.UID>,<DLOCAL.SLOTTOCONSUME_0>,<SRC.DCTAG0.ADVA>,<SRC.findlayer.21.uid>,<DLOCAL.REGNEEDED>,<DLOCAL.REGN>
ELIF (<DLOCAL.REGN> > 1)
	IF (<DLOCAL.REGN> == 2) && (<DLOCAL.SLOTTOCONSUME_0> != 0) && (<DLOCAL.SLOTTOCONSUME_1> != 0)
		SRC.ANIM 9
		SRC.EMOTE start dancing the tchaka and mix stuff
		TIMERF 2, SRC.ANIM 9
		TIMERF 3, F_CRAFTKEG <REF1.UID>,<DLOCAL.SLOTTOCONSUME_0>,<SRC.DCTAG0.ADVA>,<SRC.findlayer.21.uid>,<DLOCAL.REGNEEDED>,<DLOCAL.REGN>,<DLOCAL.SLOTTOCONSUME_1>
	ELIF (<DLOCAL.REGN> == 3) && (<DLOCAL.SLOTTOCONSUME_0> != 0) && (<DLOCAL.SLOTTOCONSUME_1> != 0) && (<DLOCAL.SLOTTOCONSUME_2> != 0)
		SRC.ANIM 9
		SRC.EMOTE start dancing the tchaka and mix stuff
		TIMERF 2, SRC.ANIM 9
		TIMERF 3, F_CRAFTKEG <REF1.UID>,<DLOCAL.SLOTTOCONSUME_0>,<SRC.DCTAG0.ADVA>,<SRC.findlayer.21.uid>,<DLOCAL.REGNEEDED>,<DLOCAL.REGN>,<DLOCAL.SLOTTOCONSUME_1>,<DLOCAL.SLOTTOCONSUME_2>
	ELIF (<DLOCAL.REGN> == 4) && (<DLOCAL.SLOTTOCONSUME_0> != 0) && (<DLOCAL.SLOTTOCONSUME_1> != 0) && (<DLOCAL.SLOTTOCONSUME_2> != 0) && (<DLOCAL.SLOTTOCONSUME_3> != 0)
		SRC.ANIM 9
		SRC.EMOTE start dancing the tchaka and mix stuff
		TIMERF 2, SRC.ANIM 9
		TIMERF 3, F_CRAFTKEG <REF1.UID>,<DLOCAL.SLOTTOCONSUME_0>,<SRC.DCTAG0.ADVA>,<SRC.findlayer.21.uid>,<DLOCAL.REGNEEDED>,<DLOCAL.REGN>,<DLOCAL.SLOTTOCONSUME_1>,<DLOCAL.SLOTTOCONSUME_2>,<DLOCAL.SLOTTOCONSUME_3>
	ENDIF
ELSE
	SRC.SYSMESSAGE @,,1 Ocorreu um erro, envie uma page. [erro 1]
	SRC.F_KEG_RESETCTAGS
ENDIF

[FUNCTION F_KEG_RESETCTAGS]
SRC.CTAG.KEGTOBEDONE
SRC.CTAG.ADVAREG_0
SRC.CTAG.ADVAREG_1
SRC.CTAG.ADVAREG_2
SRC.CTAG.ADVAREG_3

[FUNCTION f_keg_rmv_send]
	LOCAL.SLOT <SRC.DCTAG0.REGREMOVAL>
	LOCAL.AMTTOREMOVE <ARGS>
	REF1 <UID.<SRC.CTAG0.ALCHKITCLICKED>>
	IF (<REF1.TAG0.REG<DLOCAL.SLOT>>) //VERIFICA SE O SLOT SELECIONADO PARA ESVAZIAR ESTA VAZIO
		//NAO ESTA VAZIO, REMOVER E DEPOSITAR NO BANK OS REGS
		IF <REF1.DTAG0.REG<DLOCAL.SLOT>_AMT> >= <DLOCAL.AMTTOREMOVE>
			SERV.NEWITEM <REF1.TAG0.REG<DLOCAL.SLOT>>
			NEW.AMOUNT <DLOCAL.AMTTOREMOVE>
			//NEW.AMOUNT <eval <REF1.dTAG0.REG<DLOCAL.SLOT>_AMT>>
			NEW.CONT <SRC.FINDLAYER.29.UID>
			REF1.TAG0.REG<DLOCAL.SLOT>_AMT -= <DLOCAL.AMTTOREMOVE>
			SRC.SYSMESSAGE @,,1 <DLOCAL.AMTTOREMOVE> <REF1.TAG0.REG<DLOCAL.SLOT>_NAME> depositado em seu bank.
			IF (0 == <REF1.DTAG0.REG<DLOCAL.SLOT>_AMT>)
				REF1.TAG0.REG<DLOCAL.SLOT>
				REF1.TAG0.REG<DLOCAL.SLOT>_NAME Vazio
				REF1.TAG0.REG<DLOCAL.SLOT>_AMT
			ELIF (<REF1.DTAG0.REG<DLOCAL.SLOT>_AMT> > 0)
				SRC.DIALOG D_ADV_ALCH_KIT
				SRC.DCTAG0.REGREMOVAL
			ELSE
				SRC.SYSMESSAGE @,,1 Ocorreu um erro. A staff foi notificada.
				SERV.WRITEFILE Advalch_Error.txt Erro no item de <src.name>. Amount negativo apos remover do ITEM: <REF1.UID> - em: <SERV.RTIME>
			ENDIF
		ELSE
			SRC.SYSMESSAGE @,,1 O Kit nao contem esse amount de <REF1.TAG0.REG<DLOCAL.SLOT>_NAME>.
			SRC.DIALOG D_ADV_ALCH_KIT
			SRC.DCTAG0.REGREMOVAL
			RETURN 1
		ENDIF

	ELSE //ESTA VAZIO, NAO FAZER NADA
		SRC.SYSMESSAGE @,,1 O Slot selecionado [<dlocal.slot>] esta vazio.
		SRC.DIALOG D_ADV_ALCH_KIT
		SRC.DCTAG0.REGREMOVAL
		RETURN 1
	ENDIF

[EOF]